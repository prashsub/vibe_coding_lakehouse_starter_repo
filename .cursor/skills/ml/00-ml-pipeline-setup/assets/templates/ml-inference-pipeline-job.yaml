# =============================================================================
# ML Inference Pipeline Job — Asset Bundle Template
# =============================================================================
# COPY this file into your project's resources/ml/ directory.
# Replace {project} with your project name.
#
# ⚠️ PACKAGE VERSIONS MUST MATCH YOUR TRAINING PIPELINE.
#    Mismatches between training and inference cause deserialization
#    warnings and potential inference failures.
#
# Schedule runs daily after Gold layer refresh.
# Uses fe.score_batch for automatic feature retrieval.
#
# See: references/dab-integration.md for full Asset Bundle patterns.
# =============================================================================

resources:
  jobs:
    ml_inference_pipeline_job:
      name: "[${bundle.target}] ML Inference Pipeline"
      description: "Batch inference using fe.score_batch"

      # PIN EXACT VERSIONS — MUST match training pipeline
      environments:
        - environment_key: default
          spec:
            environment_version: "4"
            dependencies:
              - "mlflow==3.7.0"                          # MUST match training
              - "databricks-feature-engineering==0.8.0"   # MUST match training
              - "xgboost==2.0.3"                          # MUST match training
              - "scikit-learn==1.3.2"                     # MUST match training
              - "pandas==2.1.4"                           # MUST match training

      tasks:
        - task_key: batch_inference
          environment_key: default
          notebook_task:
            notebook_path: ../../src/{project}_ml/inference/batch_inference_all_models.py
            base_parameters:  # NOT parameters with --flags!
              catalog: ${var.catalog}
              gold_schema: ${var.gold_schema}
              feature_schema: ${var.feature_schema}
          timeout_seconds: 7200

      # Schedule: Daily after Gold layer refresh
      schedule:
        quartz_cron_expression: "0 0 5 * * ?"
        timezone_id: "America/Los_Angeles"
        pause_status: PAUSED  # Enable in production

      tags:
        environment: ${bundle.target}
        project: "{project}"
        layer: ml
        job_type: inference
