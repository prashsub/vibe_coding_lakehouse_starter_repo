# Databricks Asset Bundle ML Job Configuration Template
# Use this template for training and inference jobs

resources:
  jobs:
    ml_training_job:
      name: "[${bundle.target}] ML Training - {model_name}"
      description: "Trains {model_name} model with MLflow 3.1+ tracking"
      
      # Shared environment for all tasks
      environments:
        - environment_key: default
          spec:
            environment_version: "4"
            dependencies:
              - "mlflow==3.7.0"                    # Pin exact version
              - "databricks-feature-engineering>=0.6.0"
              - "xgboost==2.0.3"                  # Pin exact version
              - "scikit-learn==1.3.2"             # Pin exact version
              - "pandas==2.1.4"
              - "numpy==1.26.2"
      
      tasks:
        - task_key: train_{model_name}
          environment_key: default
          notebook_task:
            notebook_path: ../../src/ml/models/{model_name}/train.py
            base_parameters:  # NOT parameters with --flags!
              catalog: ${var.catalog}
              gold_schema: ${var.gold_schema}
              feature_schema: ${var.ml_schema}
              model_name: {model_name}
          timeout_seconds: 3600
      
      # Schedule: Weekly retraining (adjust as needed)
      schedule:
        quartz_cron_expression: "0 0 2 ? * SUN"
        timezone_id: "America/Los_Angeles"
        pause_status: PAUSED  # Enable in production
      
      timeout_seconds: 14400  # 4 hours total
      
      # âŒ DO NOT define experiments in Asset Bundle - creates duplicates!
      # experiments:
      #   my_experiment:
      #     name: /Shared/my_experiment  # Don't do this!
      
      tags:
        environment: ${bundle.target}
        project: wanderbricks
        layer: ml
        job_type: training

---
# Batch Inference Job Template

resources:
  jobs:
    ml_batch_inference_job:
      name: "[${bundle.target}] ML Batch Inference - {model_name}"
      
      environments:
        - environment_key: default
          spec:
            environment_version: "4"
            dependencies:
              - "mlflow==3.7.0"                    # MUST match training version
              - "databricks-feature-engineering>=0.6.0"
              - "xgboost==2.0.3"                  # Required for XGBoost models
              - "pandas==2.1.4"
      
      tasks:
        - task_key: score_{model_name}
          environment_key: default
          notebook_task:
            notebook_path: ../../src/ml/inference/batch_inference.py
            base_parameters:
              catalog: ${var.catalog}
              model_name: {model_name}
              input_table: ${var.catalog}.${var.gold_schema}.{input_table}
              output_table: ${var.catalog}.${var.ml_schema}.{output_table}
              model_version: latest
              feature_schema: ${var.ml_schema}
          timeout_seconds: 1800
      
      tags:
        environment: ${bundle.target}
        project: wanderbricks
        layer: ml
        job_type: inference
